---
title: "Chapter2_DRS" 
author: "Olga Tosas" 
date: "`r Sys.Date()`" 
output:  
  html_fragment: 
    # Don't include a table of contents 
    toc: no 
    # Set standard figure width to 12 inches 
    fig_width: 12 
    # Don't write figure captions 
    fig_caption: FALSE 
---



```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, 
                      results = "asis",
                      message = FALSE,
                      warning = FALSE,
                      aged.print=FALSE,
                      fig.align = "center")

library(ggplot2)
library(gridExtra)
library(grid)
library(plyr)
library(dplyr)
library(data.table)
library(tibble)
library(tidyr)
library(RColorBrewer)
library(tidyverse)
library(devtools) 
library(whomap)
library(RColorBrewer)
library(gtbreport)
library(here)



```

<style type="text/css">

/* Styles to make it easier to see in the html_fragment; this CSS can be included in the CSS widget of Sitefinity */


.red, .red a {
  color: #F21905; /* red text to show figure number */
}

.textbox {
    width: 100%;
    background-color: #daeef4;
    font-family: Arial, Helvetica, sans-serif;
    text-align: justify;
    text-justify: inter-word;
    padding: 15px;
}

</style>

<h1>Chapter</h1>

<h2> 2.3 Drug-resistant TB </h2>

[**Red text should appear as links once content is posted on the web **]
<p>Globally, about one quarter of deaths due to antimicrobial resistance (AMR) are caused by rifampicin-resistant tuberculosis (RR-TB) *(1)*, which includes multidrug-resistant TB (MDR-TB). The latter is defined as resistance to rifampicin and isoniazid, both of which are essential components of the first-line treatment regimen for TB and the two most effective anti-TB drugs. Isoniazid is also the most commonly used drug for TB preventive treatment. People with MDR-TB or RR-TB (MDR/RR-TB) require treatment with second-line drugs. Those with resistance to isoniazid but without resistance to rifampicin require a modified fluoroquinolone-containing treatment regimen. Fluoroquinolones are also a key component of all-oral treatment regimens for RR-TB. </p>
<p>Since 1994, the World Health Organization (WHO) has systematically collected and analysed data on levels of resistance to anti-TB drugs from countries and territories (<span class="red"><a href="#Box. 2.3.1"> Box. 2.3.1</a></span>). On an annual basis, these data have been used to produce global, regional and country-specific estimates of the number of incident cases of MDR/RR-TB for the latest calendar year, the proportions of TB cases with various combinations of resistance to first-line and second-line drugs, and global estimates of the number of TB cases with resistance to fluoroquinolones. For selected countries, the data can be used to assess trends in the burden of MDR/RR-TB. </p>
<p>Globally, there were an estimated **FIX ME** incident cases (95% uncertainty interval [UI]: **FIX ME**– **FIX ME**) of MDR/RR-TB in 2020 (<span class="red"><a href="#Table 2.3.1"> Table 2.3.1</a></span>). This is a downward revision from WHO’s estimate of 465 000 (95% UI: 400 000–535 000) incident cases in 2019 *(2)*, and is almost entirely explained by downward revisions to estimates for China and India following the availability of surveillance data from routine diagnostic testing that met coverage standards for the first time in 2020 (Annex E5). Worldwide, an estimated **FIX ME**% (95% confidence interval [CI]: **FIX ME**–**FIX ME**%) of new cases and **FIX ME**% (95% CI: **FIX ME**–**FIX ME**%) of previously treated cases had MDR/RR-TB in 2020 (<span class="red"><a href="#Table 2.3.2"> Table 2.3.2</a></span>). </p>
<p>Globally, there were **FIX ME** million incident cases (95% UI: **FIX ME**–**FIX ME** million) of isoniazid-resistant TB in 2020 (<span class="red"><a href="#Table 2.3.1"> Table 2.3.1</a></span>). The estimated global proportions of cases with isoniazid-resistant TB were **FIX ME**% (95% CI: **FIX ME**– **FIX ME**%) for new cases and **FIX ME**% (95% CI: **FIX ME**–**FIX ME**%) for previously treated cases. The global proportion of incident TB cases estimated to have isoniazid-resistant but rifampicin-susceptible TB was **FIX ME**%. People with isoniazid-resistant TB may be missed in settings where diagnostic algorithms prioritize the detection of rifampicin resistance; hence, they may not receive the modified treatment regimen recommended by WHO *(3)*. </p>
<p>The proportion of TB cases with MDR/RR-TB varied considerably among the six WHO regions (<span class="red"><a href="#Table 2.3.2"> Table 2.3.2</a></span>). For new cases, best estimates ranged from less than **FIX ME**% in the WHO African, Eastern Mediterranean and Western Pacific regions, to **FIX ME**% in the European Region. For previously treated cases, they ranged from **FIX ME**% in the WHO Western Pacific Region to **FIX ME**% in the European Region. </p>
<p>At country level, the highest proportions of TB cases with MDR/RR-TB were in several countries of the former Soviet Union, where they reached above 20% in new cases and above 50% in previously treated cases (<span class="red"><a href="#Fig. 2.3.1"> Fig. 2.3.1</a></span>, <span class="red"><a href="#Fig. 2.3.2"> Fig. 2.3.2</a></span>). In terms of absolute numbers of incident cases, the highest burdens in 2020 were in India (**FIX ME**% of global cases), China (**FIX ME**% of global cases) and the Russian Federation (**FIX ME**% of global cases) (<span class="red"><a href="#Fig. 2.3.3"> Fig. 2.3.3</a></span>). </p>
<p>In 2020, there were an estimated **FIX ME** deaths (95% UI: **FIX ME**–**FIX ME**) from MDR/RR-TB. </p>
<p>The burden of MDR/RR-TB relative to the number of new and previously treated cases remains stable globally. At the national level, the proportion of TB cases with MDR/RR-TB should be interpreted within the overall context of the country’s TB epidemic. For 30 countries with a population of at least 10 million in 2020 and with more than three data points on the level of MDR-TB from 2010 to 2020, changes in the percentage of new TB cases with MDR-TB are shown in <span class="red"><a href="#Fig. 2.3.4"> Fig. 2.3.4</a></span>. Changes were modest in most countries. Mongolia and Myanmar are examples of countries with a relatively large increase in the percentage of cases with MDR-TB, whereas Egypt and Portugal are examples of countries with a relatively large decrease. </p>
<p>In 2020, **FIX ME** countries had representative data from the past 15 years on resistance to fluoroquinolones. Of these, **FIX ME** were among the 43 countries that are in one or both of the WHO lists of high TB burden and high MDR/RR-TB burden countries being used in the period 2021–2025. Globally, the proportion of MDR/RR-TB cases with resistance to any fluoroquinolone for which testing was done was **FIX ME**% (95% CI: `r **FIX ME**– **FIX ME**%). </p>
<p>Further country-specific details about the proportions of new and previously treated TB cases that have MDR/RR-TB and estimates of the number of people who developed MDR/RR-TB in 2020 are available in the <span class="red"> Global tuberculosis report app </span> and <span class="red"> online country profiles </span>. </p>


<div class="textbox"><strong><p>Box 2.3.1 <br>Sources of data to estimate levels of anti-TB drug resistance </p></strong><br>
The Global Project on Anti-TB Drug Resistance Surveillance, established and hosted by WHO since 1994, is the world’s oldest and largest global surveillance system for AMR *(4)*. Representative data on drug resistance are currently available for 184 countries and territories worldwide, which collectively account for more than 96% of the world’s population and incident cases of TB. With the expansion of rapid molecular tools, an increasing number of countries have transitioned from a reliance on periodic surveys to the establishment of continuous surveillance systems based on routine drug susceptibility testing (DST) of Mycobacterium tuberculosis isolates for at least rifampicin, and for at least 80% of patients with bacteriologically confirmed pulmonary TB. Of the 184 countries and territories with representative data in 2020, 137 have continuous surveillance systems and 47 rely on epidemiological surveys of bacterial isolates collected from representative samples of patients (<span class="red"><a href="#Fig. 2.3.5"> Fig. 2.3.5</a></span>).
The global coverage of drug-resistance surveillance data is shown in <span class="red"><a href="#Fig. 2.3.6"> Fig. 2.3.6</a></span>. A total of 39 of the 43 countries that are in one or both of the WHO lists of high TB burden and high MDR/RR-TB burden countries being used in the period 2021–2025 have data on levels of drug resistance. The number of data points on rifampicin resistance is shown for each country in <span class="red"><a href="#Fig. 2.3.7"> Fig. 2.3.7</a></span>. 
WHO published the sixth edition of *Guidance for the surveillance of drug resistance in tuberculosis* in 2021 *(5)*. The new edition provides the latest quality standards for surveillance of drug resistance in TB, aligned with important new developments in the field.

</div>

<p><strong>References</strong></p>
1.	Review on antimicrobial resistance. Tackling drug-resistant infections globally: final report and recommendations. 2016 (https://amr-review.org/sites/default/files/160525_Final%20paper_with%20cover.pdf, accessed 13 August 2021).
2.	Global tuberculosis report 2020. Geneva: World Health Organization; 2020 (https://www.who.int/publications/i/item/9789240013131, accessed 2 August 2021). 
3.	WHO consolidated guidelines on tuberculosis, Module 4: Treatment – drug-resistant tuberculosis treatment. Geneva: World Health Organization; 2020 (https://www.who.int/publications/i/item/9789240007048, accessed 13 August 2021). 
4.	Zignol M, Dean AS, Falzon D, et al. Twenty years of global surveillance of antituberculosis-drug resistance. N Eng J Med. 2016;375(11):1081–9 (https://www.nejm.org/doi/10.1056/NEJMsr1512438, accessed 16 August 2021).
5.	Guidance for the surveillance of drug resistance in tuberculosis: Sixth edition. Geneva: World Health Organization; 2021 (https://www.who.int/publications/i/item/9789240018020, accessed 13 August 2021). 




<h3><span style="color:#F21905">Fig. 2.3.1</span> Percentage of new TB cases with MDR/RR-TB<sup>a<sup></h3>
```{r code-for-231, echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png'}



# Create connection string
connection_string <- "driver={SQL Server}; server=ssdb231.who.int; database=TMEData; uid=TMEDATA_reader; pwd=Tmere@d3r"
# Connect to the database
require(RODBC)
ch <- odbcDriverConnect(connection_string)
# Load view into a dataframe
rn1 <- sqlFetch(ch, "view_DRS_most_recent_for_estimation")
# Close the connection
close(ch)



rn2<-rn1 %>% select(country,iso3, year_new, source_new, surv_quality_new, dst_rlt_new,           
                  mdr_new, mdr_new_pcnt, dr_r_nh_new, dr_r_nh_new_pcnt,       
                  xpert_new, xpert_dr_r_new,xpert_dr_r_new_pcnt,
                  r_rlt_new, rr_new, rr_new_pcnt)


rn3<-rn2 %>% 
  mutate(RR_NEW_GR_2021 = case_when(!is.na(surv_quality_new) & year_new >=2017 & source_new == "Surveillance" ~ round((rr_new / r_rlt_new)*100,1), 
                                    !is.na(surv_quality_new) & between(year_new, 2012, 2016) & source_new == "Surveillance" ~ round(((coalesce(dr_r_nh_new,0) + coalesce(mdr_new,0) + coalesce(xpert_dr_r_new,0)) / (coalesce(dst_rlt_new,0) + coalesce(xpert_new,0)))*100,1), 
                                    !is.na(surv_quality_new) & year_new <=2011 & source_new == "Surveillance" ~ round(((coalesce(dr_r_nh_new,0) + coalesce(mdr_new,0)) / dst_rlt_new)*100,1), 
                                    !is.na(surv_quality_new) & year_new >=2018 & source_new == "Survey" ~ round(rr_new_pcnt,1), 
                                    !is.na(surv_quality_new) & year_new <=2012 & source_new == "Survey" ~ round(coalesce(dr_r_nh_new_pcnt,0) + coalesce(mdr_new_pcnt,0),1), 
                                    !is.na(surv_quality_new) & between(year_new, 2013, 2017) & source_new == "Survey" &  !is.na(xpert_dr_r_new_pcnt) & is.na(rr_new_pcnt) ~ round(xpert_dr_r_new_pcnt,1),
                                    !is.na(surv_quality_new) & between(year_new, 2013, 2017) & source_new == "Survey" &  is.na(xpert_dr_r_new_pcnt) & is.na(rr_new_pcnt)~ round(coalesce(dr_r_nh_new_pcnt,0) + coalesce(mdr_new_pcnt,0),1),
                                    !is.na(surv_quality_new) & between(year_new, 2013, 2017) & source_new == "Survey" &  !is.na(rr_new_pcnt) ~ round(rr_new_pcnt,1)))



# replace prevalence with NA where we have summed values that were coerced to 0 but were all NA in truth

rn4<-rn3 %>% 
  mutate(RR_NEW_GR_2021 = replace(RR_NEW_GR_2021, !is.na(surv_quality_new) & year_new <=2012 & source_new == "Survey" & is.na(dr_r_nh_new_pcnt) & is.na(mdr_new_pcnt), NA))

rn5<-rn4 %>% 
  mutate(RR_NEW_GR_2021 = replace(RR_NEW_GR_2021, !is.na(surv_quality_new) & between(year_new, 2013, 2017) & source_new == "Survey" &  is.na(xpert_dr_r_new_pcnt) & is.na(dr_r_nh_new_pcnt) & is.na(mdr_new_pcnt) & is.na(rr_new_pcnt), NA))


rn9<-rn5 %>% select(iso3, RR_NEW_GR_2021)
rn9$var<-rn9$RR_NEW_GR_2021


rn9$var<-case_when(is.na(rn9$var) ~ "No data", 
                  rn9$var<= 2.9  ~ "0 - 2.9", 
                  between(rn9$var, 3, 5.9) ~ "3 - 5.9", 
                  between(rn9$var, 6, 11.9) ~ "6 - 11.9", 
                  between(rn9$var, 12, 19.9) ~ "12 - 19.9", 
                  rn9$var >= 20 ~ "\u226520 ")


rn9$RR_NEW_GR_2021<-NULL

MasterDataFig231<-merge(rn5,rn9,by= "iso3")



save(rn9, file = here(paste("DataFig231_",Sys.Date(), ".rda")))
save(MasterDataFig231, file = here(paste("MasterDataFig231_",Sys.Date(), ".rda")))

write.csv(rn9, file=paste("C:/Users/tosaso/OneDrive - World Health Organization/WHO_WORK/R_DATA_WHO/GLOBAL_TB_REPORT/GLOBAL_REPORT/GR2021/MAPS_GR_2021/DataFig231_", Sys.Date(), ".csv"), row.names=FALSE)
write.csv(MasterDataFig231, file=paste("C:/Users/tosaso/OneDrive - World Health Organization/WHO_WORK/R_DATA_WHO/GLOBAL_TB_REPORT/GLOBAL_REPORT/GR2021/MAPS_GR_2021/MasterDataFig231_", Sys.Date(), ".csv"), row.names=FALSE)



rn9$var <- factor(rn9$var, levels = c('0 - 2.9',
                                    '3 - 5.9',
                                    '6 - 11.9',
                                    '12 - 19.9',
                                    '\u226520 '))



p1<-whomap(rn9, colours=c('#F5EB8C','#FCB56B','#F05552','#F71111','#800F0B'), na.col='#FFFFFF', legend.title = "Percentage (%)") 

p1



```
<div class="footnote"><sup>a</sup> Percentages are based on the most recent data point for countries with representative data from 2006 to 2021. Model-based estimates for countries without data are not shown. MDR-TB is a subset of RR-TB.




<h3><span style="color:#F21905">Fig. 2.3.2</span> Percentage of previously treated TB cases with MDR/RR-TB<sup>a<sup></h3>
```{r code-for-232, echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png'}


# Create connection string
connection_string <- "driver={SQL Server}; server=ssdb231.who.int; database=TMEData; uid=TMEDATA_reader; pwd=Tmere@d3r"
# Connect to the database
require(RODBC)
ch <- odbcDriverConnect(connection_string)
# Load view into a dataframe
rp1 <- sqlFetch(ch, "view_DRS_most_recent_for_estimation")


rp2<-rp1 %>% select(country,iso3, year_ret, source_ret, surv_quality_ret, dst_rlt_ret,           
                  mdr_ret, mdr_ret_pcnt, dr_r_nh_ret, dr_r_nh_ret_pcnt,       
                  xpert_ret, xpert_dr_r_ret,xpert_dr_r_ret_pcnt,
                  r_rlt_ret, rr_ret, rr_ret_pcnt)


rp3<-rp2 %>% 
  mutate(RR_ret_GR_2021 = case_when(!is.na(surv_quality_ret) & year_ret >=2017 & source_ret == "Surveillance" ~ round((rr_ret / r_rlt_ret)*100,1), 
                                    !is.na(surv_quality_ret) & between(year_ret, 2012, 2016) & source_ret == "Surveillance" ~ round(((coalesce(dr_r_nh_ret,0) + coalesce(mdr_ret,0) + coalesce(xpert_dr_r_ret,0)) / (coalesce(dst_rlt_ret,0) + coalesce(xpert_ret,0)))*100,1), 
                                    !is.na(surv_quality_ret) & year_ret <=2011 & source_ret == "Surveillance" ~ round(((coalesce(dr_r_nh_ret,0) + coalesce(mdr_ret,0)) / dst_rlt_ret)*100,1), 
                                    !is.na(surv_quality_ret) & year_ret >=2018 & source_ret == "Survey" ~ round(rr_ret_pcnt,1), 
                                    !is.na(surv_quality_ret) & year_ret <=2012 & source_ret == "Survey" ~ round(coalesce(dr_r_nh_ret_pcnt,0) + coalesce(mdr_ret_pcnt,0),1), 
                                    !is.na(surv_quality_ret) & between(year_ret, 2013, 2017) & source_ret == "Survey" &  !is.na(xpert_dr_r_ret_pcnt) & is.na(rr_ret_pcnt) ~ round(xpert_dr_r_ret_pcnt,1),
                                    !is.na(surv_quality_ret) & between(year_ret, 2013, 2017) & source_ret == "Survey" &  is.na(xpert_dr_r_ret_pcnt) & is.na(rr_ret_pcnt)~ round(coalesce(dr_r_nh_ret_pcnt,0) + coalesce(mdr_ret_pcnt,0),1),
                                    !is.na(surv_quality_ret) & between(year_ret, 2013, 2017) & source_ret == "Survey" &  !is.na(rr_ret_pcnt) ~ round(rr_ret_pcnt,1)))



# replace prevalence with NA where we have summed values that were coerced to 0 but were all NA in truth

rp4<-rp3 %>% 
  mutate(RR_ret_GR_2021 = replace(RR_ret_GR_2021, !is.na(surv_quality_ret) & year_ret <=2012 & source_ret == "Survey" & is.na(dr_r_nh_ret_pcnt) & is.na(mdr_ret_pcnt), NA))

rp5<-rp4 %>% 
  mutate(RR_ret_GR_2021 = replace(RR_ret_GR_2021, !is.na(surv_quality_ret) & between(year_ret, 2013, 2017) & source_ret == "Survey" &  is.na(xpert_dr_r_ret_pcnt) & is.na(dr_r_nh_ret_pcnt) & is.na(mdr_ret_pcnt) & is.na(rr_ret_pcnt), NA))


rp9<-rp5 %>% select(iso3, RR_ret_GR_2021)
rp9$var<-rp9$RR_ret_GR_2021


rp9$var<-case_when(is.na(rp9$var) ~ "No data", 
                  rp9$var<= 5.9  ~ "0 - 5.9", 
                  between(rp9$var, 6, 11.9) ~ "6 - 11.9", 
                  between(rp9$var, 12, 29.9) ~ "12 - 29.9", 
                  between(rp9$var, 30, 49.9) ~ "30 - 49.9", 
                  rp9$var >= 50 ~ "\u226550")
rp9$RR_ret_GR_2021<-NULL

MasterDataFig232<-merge(rp5,rp9,by= "iso3")


save(rp9, file = here(paste("DataFig232_",Sys.Date(), ".rda")))
save(MasterDataFig232, file = here(paste("MasterDataFig232_",Sys.Date(), ".rda")))

write.csv(rp9, file=paste("C:/Users/tosaso/OneDrive - World Health Organization/WHO_WORK/R_DATA_WHO/GLOBAL_TB_REPORT/GLOBAL_REPORT/GR2021/MAPS_GR_2021/DataFig232_", Sys.Date(), ".csv"), row.names=FALSE)
write.csv(MasterDataFig232, file=paste("C:/Users/tosaso/OneDrive - World Health Organization/WHO_WORK/R_DATA_WHO/GLOBAL_TB_REPORT/GLOBAL_REPORT/GR2021/MAPS_GR_2021/MasterDataFig232_", Sys.Date(), ".csv"), row.names=FALSE)


rp9$var <- factor(rp9$var, levels = c('0 - 5.9',
                                    '6 - 11.9',
                                    '12 - 29.9',
                                    '30 - 49.9',
                                    '\u226550'))



p2<-whomap(rp9, colours=c('#D6F5F5','#94D4F5','#4FE8FA','#2473FF','#081DC0'), na.col='#FFFFFF', legend.title = "Percentage (%)") 

p2

```
<div class="footnote"><sup>a</sup> Percentages are based on the most recent data point for countries with representative data from 2006 to 2021. Model-based estimates for countries without data are not shown. MDR-TB is a subset of RR-TB.




```{r code-for-masterdata-figs-235-236-237, echo=FALSE, message=FALSE, warning=FALSE}

# Create connection string
connection_string <- "driver={SQL Server}; server=ssdb231.who.int; database=TMEData; uid=TMEDATA_reader; pwd=Tmere@d3r"
# Connect to the database
require(RODBC)
ch <- odbcDriverConnect(connection_string)
# Load view into a dataframe
n1 <- sqlFetch(ch, "view_TME_master_drs")
close(ch)

# Create connection string
connection_string <- "driver={SQL Server}; server=ssdb231.who.int; database=TMEData; uid=TMEDATA_reader; pwd=Tmere@d3r"
# Connect to the database
require(RODBC)
ch <- odbcDriverConnect(connection_string)
# Load view into a dataframe
ex1 <- sqlFetch(ch, "view_dr_surveillance_exclusions")
close(ch)


# Create connection string
connection_string <- "driver={SQL Server}; server=ssdb231.who.int; database=TMEData; uid=TMEDATA_reader; pwd=Tmere@d3r"
# Connect to the database
require(RODBC)
ch <- odbcDriverConnect(connection_string)
# Load view into a dataframe
dr1 <- sqlFetch(ch, "view_DRS_most_recent_for_estimation")
close(ch)


Country_Template<-dr1 %>% select(country,iso3, year_new, source_new, all_areas_covered_new, surv_quality_new)



##we will report data points excluding sub-national data, and removing unreliable records as informed by the "view_dr_surveillance_exclusions" file
##we only use A, N data for new cases. 
## the only sub-national data we want to keep is that from CAF, PNG, BRZ and PRK because these data are considered by WHO when producing global estimates.
##to count available data points for RR-TB, we will check that data is indeed available to calculate prevalence of RR-TB among new cases, by using the same code that is used for the
#prevalence maps. Note that if the RR-TB prevalence can only be calculated for new and previously treated cases combined (e.g. new plus prev treated [prevalence only provided for "unk" category]),
#then, this also DOES NOT COUNT as a data point of RR-TB among new cases.


n2<-n1 %>% select(country,iso3, g_whoregion, year, drs_record_type, surv_quality, all_areas_covered, dst_rlt_new,           
                  mdr_new, mdr_new_pcnt, dr_r_nh_new, dr_r_nh_new_pcnt,       
                  xpert_new, xpert_dr_r_new,xpert_dr_r_new_pcnt,
                  r_rlt_new, rr_new, rr_new_pcnt)

n2$drs_record_type <- recode(n2$drs_record_type, "pre-2010 TME data collection" = "Surveillance")

#select data for the past 25 years. For the 2021 Global TB report, this would correspond to data from 1996-2021 (which is the same as >1995)

n3<- n2 %>%
  filter(year>(as.numeric(format(Sys.Date(), "%Y"))-26))%>% 
  droplevels()


#check which records with surv_quality "A" or "N" actually had no data to estimate the proportion of RR-TB, and should consequently be excluded


n4<-n3 %>% 
  mutate(RR_NEW_GR_2021 = case_when((surv_quality =="A" | surv_quality =="N") & year >=2017 & drs_record_type == "Surveillance" ~ round((rr_new / r_rlt_new)*100,1), 
                                    (surv_quality =="A" | surv_quality =="N") & between(year, 2012, 2016) & drs_record_type == "Surveillance" ~ round(((coalesce(dr_r_nh_new,0) + coalesce(mdr_new,0) + coalesce(xpert_dr_r_new,0)) / (coalesce(dst_rlt_new,0) + coalesce(xpert_new,0)))*100,1), 
                                    (surv_quality =="A" | surv_quality =="N") & year <=2011 & drs_record_type == "Surveillance" ~ round(((coalesce(dr_r_nh_new,0) + coalesce(mdr_new,0)) / dst_rlt_new)*100,1), 
                                    (surv_quality =="A" | surv_quality =="N") & year >=2018 & drs_record_type == "Survey" ~ round(rr_new_pcnt,1), 
                                    (surv_quality =="A" | surv_quality =="N") & year <=2012 & drs_record_type == "Survey" ~ round(coalesce(dr_r_nh_new_pcnt,0) + coalesce(mdr_new_pcnt,0),1), 
                                    (surv_quality =="A" | surv_quality =="N") & between(year, 2013, 2017) & drs_record_type == "Survey" &  !is.na(xpert_dr_r_new_pcnt) & is.na(rr_new_pcnt) ~ round(xpert_dr_r_new_pcnt,1),
                                    (surv_quality =="A" | surv_quality =="N") & between(year, 2013, 2017) & drs_record_type == "Survey" &  is.na(xpert_dr_r_new_pcnt) & is.na(rr_new_pcnt)~ round(coalesce(dr_r_nh_new_pcnt,0) + coalesce(mdr_new_pcnt,0),1),
                                    (surv_quality =="A" | surv_quality =="N") & between(year, 2013, 2017) & drs_record_type == "Survey" &  !is.na(rr_new_pcnt) ~ round(rr_new_pcnt,1)))

# replace prevalence with NA where we have summed values that were coerced to 0 but were all NA in truth

n5<-n4 %>% 
  mutate(RR_NEW_GR_2021 = replace(RR_NEW_GR_2021, !is.na(surv_quality) & year <=2012 & drs_record_type == "Survey" & is.na(dr_r_nh_new_pcnt) & is.na(mdr_new_pcnt), NA))

n6<-n5 %>% 
  mutate(RR_NEW_GR_2021 = replace(RR_NEW_GR_2021, !is.na(surv_quality) & between(year, 2013, 2017) & drs_record_type == "Survey" &  is.na(xpert_dr_r_new_pcnt) & is.na(dr_r_nh_new_pcnt) & is.na(mdr_new_pcnt) & is.na(rr_new_pcnt), NA))



#exclude records where the percentage of RR-TB among new cases cannot be calculated. This is a combination of data where surv_quality is not "A" and is not "N", and cases where survey quality is "A" or "N" BUT
#there was actually no data or denominator data was zero:

n9<- n6 %>%
  filter(!is.na(RR_NEW_GR_2021))%>% 
  droplevels()


#now we must exclude sub-national data, except for sub-national data from CAF, BRA, PRK, PNG

n10<- n9 %>%
  filter(all_areas_covered == 1 | (all_areas_covered == 0 & (iso3 == "CAF" | iso3 == "BRA" | iso3 == "PRK" | iso3 == "PNG")) )%>% 
  droplevels()


#we must also exclude surveillance data from new cases, if this is in "view_dr_surveillance_exclusions"

ex2<- ex1 %>%
  filter(rm_new == 1)%>% 
  droplevels()%>%
  select(iso3,year)%>%
  mutate(drs_record_type = "Surveillance")%>%
  mutate(exclude = "exclude")

n11<-merge(n10,ex2,by=c("iso3","year","drs_record_type"),all.x = TRUE, all.y = FALSE)


n12<- n11 %>%
  filter(is.na(exclude))%>% 
  droplevels()%>% 
  select(-exclude)

#COUNT NUMBER OF DATAPOINTS PER COUNTRY 
#A difference this year is that if for a particular year both survey and surveillance data are available, then this is counted as two data points.
#This was agreed with Anna

n_count<-n12 %>% group_by(iso3) %>% tally() %>%
rename(data_points=n)

#GET LATEST YEAR OF DATA AND LATEST SOURCE OF DATA
#these data include more years than that considered in view_drs_most_recent_for_estimation (2006-2021), and hence is taken from view_TME_master_drs (but is restricted to the past 25 years [1996-2021])
#now we select the most recent year of data along with the drs_record_type; if both survey and surveillance data are available for the last year, there will be 2 data points for the latest year of data. To
#avoid duplicate records, we spread drs_record_type data into two columns. In these cases, because surveillance data of quality A or N is prioritized over survey data (unless listed in the exclusions list), this will be
#reflected in the final selection of source in cases where data is too old to be in view_drs_most_recent_for_estimation (data taken from the latter is already de-duplicated).

n13<-n12 %>% select(country,iso3,year,drs_record_type, all_areas_covered) %>%
spread(drs_record_type, drs_record_type) %>%
group_by(country) %>% top_n(1, year)

#Now we merge n_count and n13 with our Country_Template data, which is based on view_drs_most_recent for estimation. This also serves to validate the data from n13
  
Data_Figs_5_6_7a<-merge(Country_Template,n_count,by=c("iso3"),all.x = TRUE, all.y = FALSE)

Data_Figs_5_6_7_b<-merge(Data_Figs_5_6_7a,n13,by=c("iso3"),all.x = TRUE, all.y = FALSE)


Data_Figs_5_6_7_c<-Data_Figs_5_6_7_b %>% 
mutate(most_recent_year = case_when(!is.na(year_new)  ~ year_new, 
                               TRUE ~ year)) %>%
mutate(most_recent_source = case_when(!is.na(year_new)  ~ source_new, 
                                      is.na(year_new)& !is.na(Surveillance) ~ Surveillance,
                                      TRUE ~ Survey))%>%
                                      rename(country=country.x) %>%
                                      select(country, iso3, all_areas_covered,data_points, most_recent_year, most_recent_source)

#for countries where there is no previous data, flag those that are planning or ongoing surveys this year. This part of the code
#must be reviewed every year

Data_Figs_5_6_7_d<-Data_Figs_5_6_7_c %>% 
  mutate(most_recent_year = replace(most_recent_year, iso3 == "BDI" | iso3 == "NER" |iso3 == "TCD" | iso3 == "HTI", "Ongoing in 2021")) %>% 
  mutate(most_recent_year = replace(most_recent_year,is.na(most_recent_year), "No data")) %>% 
  mutate(most_recent_source = replace(most_recent_source,is.na(most_recent_source), "No data")) %>% 
  mutate(all_areas_covered = case_when(all_areas_covered ==1  ~ "Nationwide", 
                                           all_areas_covered ==0  ~ "Subnational",
                                           TRUE ~ "No data")) %>% 
  mutate(most_recent_year_ranked = case_when(most_recent_year == "No data" | most_recent_year == "Ongoing in 2021"~ most_recent_year, 
                  between(most_recent_year, 1996, 2000) ~ "1996 - 2000", 
                  between(most_recent_year, 2001, 2005) ~ "2001 - 2005", 
                  between(most_recent_year, 2006, 2010) ~ "2006 - 2010", 
                  between(most_recent_year, 2011, 2015) ~ "2011 - 2015", 
                  between(most_recent_year, 2016, 2021) ~ "2016 - 2021"))



save(Data_Figs_5_6_7_d, file = here(paste("MasterDataFig235_6_7_",Sys.Date(), ".rda")))
write.csv(Data_Figs_5_6_7_d, file=paste("C:/Users/tosaso/OneDrive - World Health Organization/WHO_WORK/R_DATA_WHO/GLOBAL_TB_REPORT/GLOBAL_REPORT/GR2021/MAPS_GR_2021/MasterDataFig235_6_7_", Sys.Date(), ".csv"), row.names=FALSE)



```


<h3><span style="color:#F21905">Fig. 2.3.5</span> Source of data for rifampicin resistance among new cases, 1996&#8211;2021</h3>
```{r code-for-235, echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png'}

dataFig235 <- Data_Figs_5_6_7_d %>% 
  select(iso3, most_recent_source) %>%
  rename(var=most_recent_source)
  
dataFig235$var <- factor(dataFig235$var, levels = c("Surveillance", "Survey"))


p3<-whomap(dataFig235, colours=c("#FCBA78", "#965B44"), na.col='#FFFFFF', legend.title = "Source") 

p3

```





<h3><span style="color:#F21905">Fig. 2.3.6</span> Most recent year of data on rifampicin resistance among new cases, 1996&#8211;2021<sup>a<sup></h3>
```{r code-for-236, echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png'}

dataFig236 <- Data_Figs_5_6_7_d %>% 
  select(iso3, most_recent_year_ranked) %>%
  rename(var=most_recent_year_ranked)
  

dataFig236$var <- factor(dataFig236$var, levels = c('1996 - 2000',
                                    '2001 - 2005',
                                    '2006 - 2010',
                                    '2011 - 2015',
                                    '2016 - 2021',
                                    'Ongoing in 2021'))

p4<-whomap(dataFig236, colours=c('#DBFABF', '#B3FA5E', '#70D112', '#4CB45A', '#224624', '#FCBA78'), na.col='#FFFFFF', legend.title = "Most recent year of data", legend.pos=c(0.14, 0.42)) + add_marker(c('BRA', 'CAF', 'PNG', 'PRK'), lab='Subnational data', size=2)

p4

```
<div class="footnote"><sup>a</sup> Ongoing in 2021 refers to first-ever national surveys of anti-TB drug resistance that are being planned or implemented. For countries that are planning or implementing repeat surveys, the most recent year of data is shown.



<h3><span style="color:#F21905">Fig. 2.3.7</span> Number of data points on rifampicin resistance among new cases, 1996&#8211;2021<sup>a<sup></h3>
```{r code-for-237, echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png'}

dataFig237 <- Data_Figs_5_6_7_d %>% 
  select(iso3, data_points) %>%
  rename(var=data_points)
  

dataFig237$var <- case_when(dataFig237$var<= 1 ~ '1',
                            dataFig237$var== 2 ~ '2',
                    between(dataFig237$var, 3, 5) ~ '3-5',
                    between(dataFig237$var, 6, 10) ~ '6-10',
                    between(dataFig237$var, 11, 15) ~ '11-15',
                    dataFig237$var >= 16 ~ "\u226516",
                    is.na(dataFig237$var)~ 'No data')

dataFig237$var <- factor(dataFig237$var, levels = c('1',
                                    '2',
                                    '3-5',
                                    '6-10',
                                    '11-15',
                                    '\u226516'))

save(dataFig237, file = here(paste("dataFig237_",Sys.Date(), ".rda")))


p5<-whomap(dataFig237, colours=c('#F5EB8C', '#FCB56B', '#CFFC19', '#56FC1C', '#4CB45A', '#1B640F'), na.col='#FFFFFF', legend.title = "Number", legend.pos=c(0.14, 0.34)) 

p5

```
<div class="footnote"><sup>a</sup> In 2019–2021, first-ever national drug-resistance surveys were completed in Mali and Timor-Leste, and repeat surveys were completed in Bangladesh, Malawi, the Philippines and Zambia (provisional results).




